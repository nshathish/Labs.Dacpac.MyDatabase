# File: .github/workflows/deploy-sql-mi.yml

name: Deploy DACPAC to Azure SQL MI

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  PROJECT_NAME: Labs.Dacpac.MyDatabase
  PROJECT_PATH: Labs.Dacpac.MyDatabase/Labs.Dacpac.MyDatabase.sqlproj
  DACPAC_FILE: Labs.Dacpac.MyDatabase/bin/Release/Labs.Dacpac.MyDatabase.dacpac

jobs:
  # ðŸ§± BUILD JOB - Builds DACPAC cross-platform using .NET SDK
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: "9.0.x"

      - name: Restore dependencies
        run: dotnet restore ${{ env.PROJECT_PATH }}

      - name: Build DACPAC
        run: |
          dotnet build ${{ env.PROJECT_PATH }} \
            -p:NetCoreBuild=true \
            -c Release \
            --no-restore

      - name: Upload DACPAC artifact
        uses: actions/upload-artifact@v5
        with:
          name: ${{ env.PROJECT_NAME }}.${{ github.run_id }}
          path: ${{ env.DACPAC_FILE }}

  # ðŸš€ DEPLOY JOB - Runs on Linux to use Azure CLI
  deploy:
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Download DACPAC artifact
        uses: actions/download-artifact@v5
        with:
          name: ${{ env.PROJECT_NAME }}.${{ github.run_id }}
          path: dacpac

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Install and Run sqlpackage for SQL MI
        run: |
          echo "Installing sqlpackage..."
          wget -q -O sqlpackage.zip https://aka.ms/sqlpackage-linux
          sudo unzip -q sqlpackage.zip -d /usr/local/bin/sqlpackage
          sudo chmod +x /usr/local/bin/sqlpackage/sqlpackage

          echo "Deploying to Azure SQL Managed Instance..."
          /usr/local/bin/sqlpackage/sqlpackage /Action:Publish \
            /SourceFile:"dacpac/Labs.Dacpac.MyDatabase.dacpac" \
            /TargetConnectionString:"${{ secrets.AZURE_SQL_MI_CONNECTION_STRING }}" \
            /p:BlockOnPossibleDataLoss=true \
            /p:DropObjectsNotInSource=false \
            /p:VerifyDeployment=true

          echo "âœ… DACPAC deployed successfully to SQL Managed Instance"
