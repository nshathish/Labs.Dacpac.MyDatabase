# File: .github/workflows/deploy-sql-mi.yml

name: SQL DACPAC CI/CD

on:
  # ðŸ”¹ Run the build (CI) on Pull Requests targeting main
  pull_request:
    branches: [main]

  # ðŸ”¹ Run the deploy (CD) only when a PR is merged into main
  push:
    branches: [main]

  # ðŸ”¹ Allow manual triggering (optional)
  workflow_dispatch:

env:
  PROJECT_NAME: Labs.Dacpac.MyDatabase
  PROJECT_PATH: Labs.Dacpac.MyDatabase/Labs.Dacpac.MyDatabase.sqlproj
  DACPAC_FILE: Labs.Dacpac.MyDatabase/bin/Release/Labs.Dacpac.MyDatabase.dacpac

jobs:
  # ðŸ§± BUILD JOB - Builds DACPAC cross-platform using .NET SDK
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v2

      - name: Restore NuGet packages
        run: nuget restore ${{ env.PROJECT_PATH }}

      - name: Build DACPAC project
        run: msbuild "${{ env.PROJECT_PATH }}" /p:Configuration=Release

      - name: Upload DACPAC artifact
        uses: actions/upload-artifact@v5
        with:
          name: ${{ env.PROJECT_NAME }}.${{ github.run_id }}
          path: ${{ env.DACPAC_FILE }}

  # ðŸš€ DEPLOY JOB - Runs on Linux to use Azure CLI
  deploy:
    runs-on: ubuntu-latest
    needs: build
    name: Deploy DACPAC to Azure SQL Managed Instance
    # only run when it's a push event to main (i.e. PR merged)
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: Download DACPAC artifact
        uses: actions/download-artifact@v5
        with:
          name: ${{ env.PROJECT_NAME }}.${{ github.run_id }}
          path: dacpac

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Install sqlpackage
        run: |
          echo "Installing sqlpackage..."
          wget -q -O sqlpackage.zip https://aka.ms/sqlpackage-linux
          sudo unzip -q sqlpackage.zip -d /usr/local/bin/sqlpackage
          sudo chmod +x /usr/local/bin/sqlpackage/sqlpackage

      - name: Deploy DACPAC to Azure SQL Managed Instance
        run: |
          echo "Deploying DACPAC..."
          /usr/local/bin/sqlpackage/sqlpackage /Action:Publish \
            /SourceFile:"dacpac/${{ env.PROJECT_NAME }}.dacpac" \
            /TargetConnectionString:"${{ secrets.AZURE_SQL_MI_CONNECTION_STRING }}" \
            /p:IncludeCompositeObjects=true \
            /p:BlockOnPossibleDataLoss=false \
            /p:IgnorePermissions=true \
            /p:IgnoreUserSettingsObjects=true \
            /p:ExcludeObjectTypes=Users;ServerRoleMembership;ServerRoles;DatabaseRoles \
            /p:IgnoreIndexOptions=True \
            /p:IgnoreLockHintsOnIndexes=True \
            /p:DropIndexesNotInSource=False \
            /p:VerifyDeployment=true

          echo "âœ… Deployment completed successfully."
